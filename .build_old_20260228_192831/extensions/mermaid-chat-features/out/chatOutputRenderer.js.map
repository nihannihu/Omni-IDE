{"version":3,"file":"chatOutputRenderer.js","sourceRoot":"","sources":["../src/chatOutputRenderer.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nimport * as vscode from 'vscode';\r\nimport { MermaidEditorManager } from './editorManager';\r\nimport { MermaidWebviewManager } from './webviewManager';\r\nimport { escapeHtmlText } from './util/html';\r\nimport { generateUuid } from './util/uuid';\r\nimport { disposeAll } from './util/dispose';\r\n\r\n/**\r\n * Mime type used to identify Mermaid diagram data in chat output.\r\n */\r\nconst mime = 'text/vnd.mermaid';\r\n\r\n/**\r\n * View type that uniquely identifies the Mermaid chat output renderer.\r\n */\r\nconst viewType = 'vscode.chat-mermaid-features.chatOutputItem';\r\n\r\nclass MermaidChatOutputRenderer implements vscode.ChatOutputRenderer {\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _extensionUri: vscode.Uri,\r\n\t\tprivate readonly _webviewManager: MermaidWebviewManager\r\n\t) { }\r\n\r\n\tasync renderChatOutput({ value }: vscode.ChatOutputDataItem, chatOutputWebview: vscode.ChatOutputWebview, _ctx: unknown, _token: vscode.CancellationToken): Promise<void> {\r\n\t\tconst webview = chatOutputWebview.webview;\r\n\t\tconst decoded = decodeMermaidData(value);\r\n\t\tconst mermaidSource = decoded.source;\r\n\t\tconst title = decoded.title;\r\n\r\n\t\t// Generate unique ID for this webview\r\n\t\tconst webviewId = generateUuid();\r\n\r\n\t\tconst disposables: vscode.Disposable[] = [];\r\n\r\n\t\t// Register and set as active\r\n\t\tdisposables.push(this._webviewManager.registerWebview(webviewId, webview, mermaidSource, title, 'chat'));\r\n\r\n\t\t// Listen for messages from the webview\r\n\t\tdisposables.push(webview.onDidReceiveMessage(message => {\r\n\t\t\tif (message.type === 'openInEditor') {\r\n\t\t\t\tvscode.commands.executeCommand('_mermaid-chat.openInEditor', { mermaidWebviewId: webviewId });\r\n\t\t\t}\r\n\t\t}));\r\n\r\n\t\t// Dispose resources when webview is disposed\r\n\t\tchatOutputWebview.onDidDispose(() => {\r\n\t\t\tdisposeAll(disposables);\r\n\t\t});\r\n\r\n\t\t// Set the options for the webview\r\n\t\tconst mediaRoot = vscode.Uri.joinPath(this._extensionUri, 'chat-webview-out');\r\n\t\twebview.options = {\r\n\t\t\tenableScripts: true,\r\n\t\t\tlocalResourceRoots: [mediaRoot],\r\n\t\t};\r\n\r\n\t\t// Set the HTML content for the webview\r\n\t\tconst nonce = generateUuid();\r\n\t\tconst mermaidScript = vscode.Uri.joinPath(mediaRoot, 'index.js');\r\n\t\tconst codiconsUri = webview.asWebviewUri(vscode.Uri.joinPath(mediaRoot, 'codicon.css'));\r\n\r\n\t\twebview.html = `\r\n\t\t\t<!DOCTYPE html>\r\n\t\t\t<html lang=\"en\">\r\n\r\n\t\t\t<head>\r\n\t\t\t\t<meta charset=\"UTF-8\">\r\n\t\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n\t\t\t\t<title>Mermaid Diagram</title>\r\n\t\t\t\t<meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'none'; script-src 'nonce-${nonce}'; style-src ${webview.cspSource} 'unsafe-inline'; font-src data:;\" />\r\n\t\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"${codiconsUri}\">\r\n\r\n\t\t\t\t<style>\r\n\t\t\t\t\tbody {\r\n\t\t\t\t\t\tpadding: 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.mermaid {\r\n\t\t\t\t\t\tvisibility: hidden;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.mermaid.rendered {\r\n\t\t\t\t\t\tvisibility: visible;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.open-in-editor-btn {\r\n\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\ttop: 8px;\r\n\t\t\t\t\t\tright: 8px;\r\n\t\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\t\talign-items: center;\r\n\t\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t\t\twidth: 26px;\r\n\t\t\t\t\t\theight: 26px;\r\n\t\t\t\t\t\tbackground: var(--vscode-editorWidget-background);\r\n\t\t\t\t\t\tcolor: var(--vscode-icon-foreground);\r\n\t\t\t\t\t\tborder: 1px solid var(--vscode-editorWidget-border);\r\n\t\t\t\t\t\tborder-radius: 6px;\r\n\t\t\t\t\t\tcursor: pointer;\r\n\t\t\t\t\t\tz-index: 100;\r\n\t\t\t\t\t\topacity: 0;\r\n\t\t\t\t\t\ttransition: opacity 0.2s;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbody:hover .open-in-editor-btn {\r\n\t\t\t\t\t\topacity: 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.open-in-editor-btn:hover {\r\n\t\t\t\t\t\topacity: 1;\r\n\t\t\t\t\t\tbackground: var(--vscode-toolbar-hoverBackground);\r\n\t\t\t\t\t}\r\n\t\t\t\t</style>\r\n\t\t\t</head>\r\n\r\n\t\t\t<body data-vscode-context='${JSON.stringify({ preventDefaultContextMenuItems: true, mermaidWebviewId: webviewId })}' data-vscode-mermaid-webview-id=\"${webviewId}\">\r\n\t\t\t\t<button class=\"open-in-editor-btn\" title=\"${vscode.l10n.t('Open in Editor')}\"><i class=\"codicon codicon-open-preview\"></i></button>\r\n\t\t\t\t<pre class=\"mermaid\">\r\n\t\t\t\t\t${escapeHtmlText(mermaidSource)}\r\n\t\t\t\t</pre>\r\n\r\n\t\t\t\t<script type=\"module\" nonce=\"${nonce}\" src=\"${webview.asWebviewUri(mermaidScript)}\"></script>\r\n\t\t\t</body>\r\n\t\t\t</html>`;\r\n\t}\r\n}\r\n\r\n\r\nexport function registerChatSupport(\r\n\tcontext: vscode.ExtensionContext,\r\n\twebviewManager: MermaidWebviewManager,\r\n\teditorManager: MermaidEditorManager\r\n): vscode.Disposable {\r\n\tconst disposables: vscode.Disposable[] = [];\r\n\r\n\tdisposables.push(\r\n\t\tvscode.commands.registerCommand('_mermaid-chat.openInEditor', (ctx?: { mermaidWebviewId?: string }) => {\r\n\t\t\tconst webviewInfo = ctx?.mermaidWebviewId ? webviewManager.getWebview(ctx.mermaidWebviewId) : webviewManager.activeWebview;\r\n\t\t\tif (webviewInfo) {\r\n\t\t\t\teditorManager.openPreview(webviewInfo.mermaidSource, webviewInfo.title);\r\n\t\t\t}\r\n\t\t})\r\n\t);\r\n\r\n\t// Register lm tools\r\n\tdisposables.push(\r\n\t\tvscode.lm.registerTool<{ markup: string; title?: string }>('renderMermaidDiagram', {\r\n\t\t\tinvoke: async (options, _token) => {\r\n\t\t\t\tconst sourceCode = options.input.markup;\r\n\t\t\t\tconst title = options.input.title;\r\n\t\t\t\treturn writeMermaidToolOutput(sourceCode, title);\r\n\t\t\t},\r\n\t\t})\r\n\t);\r\n\r\n\t// Register the chat output renderer for Mermaid diagrams.\r\n\t// This will be invoked with the data generated by the tools.\r\n\t// It can also be invoked when rendering old Mermaid diagrams in the chat history.\r\n\tconst renderer = new MermaidChatOutputRenderer(context.extensionUri, webviewManager);\r\n\tdisposables.push(vscode.chat.registerChatOutputRenderer(viewType, renderer));\r\n\r\n\treturn vscode.Disposable.from(...disposables);\r\n}\r\n\r\nfunction writeMermaidToolOutput(sourceCode: string, title: string | undefined): vscode.LanguageModelToolResult {\r\n\t// Expose the source code as a markdown mermaid code block\r\n\tconst fence = getFenceForContent(sourceCode);\r\n\tconst result = new vscode.LanguageModelToolResult([\r\n\t\tnew vscode.LanguageModelTextPart(`${fence}mermaid\\n${sourceCode}\\n${fence}`)\r\n\t]);\r\n\r\n\t// And store custom data in the tool result details to indicate that a custom renderer should be used for it.\r\n\t// Encode source and optional title as JSON.\r\n\tconst data = JSON.stringify({ source: sourceCode, title });\r\n\t// Add cast to use proposed API\r\n\t(result as vscode.ExtendedLanguageModelToolResult2).toolResultDetails2 = {\r\n\t\tmime,\r\n\t\tvalue: new TextEncoder().encode(data),\r\n\t};\r\n\r\n\treturn result;\r\n}\r\n\r\nfunction getFenceForContent(content: string): string {\r\n\tconst backtickMatch = content.matchAll(/`+/g);\r\n\tif (!backtickMatch) {\r\n\t\treturn '```';\r\n\t}\r\n\r\n\tconst maxBackticks = Math.max(...Array.from(backtickMatch, s => s[0].length));\r\n\treturn '`'.repeat(Math.max(3, maxBackticks + 1));\r\n}\r\n\r\ninterface MermaidData {\r\n\treadonly title: string | undefined;\r\n\treadonly source: string;\r\n}\r\n\r\nfunction decodeMermaidData(value: Uint8Array): MermaidData {\r\n\tconst text = new TextDecoder().decode(value);\r\n\r\n\t// Try to parse as JSON (new format with title), fall back to plain text (legacy format)\r\n\ttry {\r\n\t\tconst parsed = JSON.parse(text);\r\n\t\tif (typeof parsed === 'object' && typeof parsed.source === 'string') {\r\n\t\t\treturn { title: parsed.title, source: parsed.source };\r\n\t\t}\r\n\t} catch {\r\n\t\t// Not JSON, treat as legacy plain text format\r\n\t}\r\n\r\n\treturn { title: undefined, source: text };\r\n}\r\n"]}