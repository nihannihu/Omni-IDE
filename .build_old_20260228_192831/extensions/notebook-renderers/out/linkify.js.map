{"version":3,"file":"linkify.js","sourceRoot":"","sources":["../src/linkify.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\n\r\nimport { ttPolicy } from './htmlHelper';\r\n\r\nconst CONTROL_CODES = '\\\\u0000-\\\\u0020\\\\u007f-\\\\u009f';\r\nconst WEB_LINK_REGEX = new RegExp('(?:[a-zA-Z][a-zA-Z0-9+.-]{2,}:\\\\/\\\\/|data:|www\\\\.)[^\\\\s' + CONTROL_CODES + '\"]{2,}[^\\\\s' + CONTROL_CODES + '\"\\')}\\\\],:;.!?]', 'ug');\r\n\r\nconst WIN_ABSOLUTE_PATH = /(?<=^|\\s)(?:[a-zA-Z]:(?:(?:\\\\|\\/)[\\w\\.-]*)+)/;\r\nconst WIN_RELATIVE_PATH = /(?<=^|\\s)(?:(?:\\~|\\.)(?:(?:\\\\|\\/)[\\w\\.-]*)+)/;\r\nconst WIN_PATH = new RegExp(`(${WIN_ABSOLUTE_PATH.source}|${WIN_RELATIVE_PATH.source})`);\r\nconst POSIX_PATH = /(?<=^|\\s)((?:\\~|\\.)?(?:\\/[\\w\\.-]*)+)/;\r\nconst LINE_COLUMN = /(?:\\:([\\d]+))?(?:\\:([\\d]+))?/;\r\nconst isWindows = (typeof navigator !== 'undefined') ? navigator.userAgent && navigator.userAgent.indexOf('Windows') >= 0 : false;\r\nconst PATH_LINK_REGEX = new RegExp(`${isWindows ? WIN_PATH.source : POSIX_PATH.source}${LINE_COLUMN.source}`, 'g');\r\nconst HTML_LINK_REGEX = /<a\\s+(?:[^>]*?\\s+)?href=([\"'])(.*?)\\1[^>]*?>.*?<\\/a>/gi;\r\n\r\nconst MAX_LENGTH = 2000;\r\n\r\ntype LinkKind = 'web' | 'path' | 'html' | 'text';\r\ntype LinkPart = {\r\n\tkind: LinkKind;\r\n\tvalue: string;\r\n\tcaptures: string[];\r\n};\r\n\r\nexport type LinkOptions = {\r\n\ttrustHtml?: boolean;\r\n\tlinkifyFilePaths: boolean;\r\n};\r\n\r\nexport class LinkDetector {\r\n\r\n\t// used by unit tests\r\n\tstatic injectedHtmlCreator: (value: string) => string;\r\n\r\n\tprivate shouldGenerateHtml(trustHtml: boolean) {\r\n\t\treturn trustHtml && (!!LinkDetector.injectedHtmlCreator || !!ttPolicy);\r\n\t}\r\n\r\n\tprivate createHtml(value: string) {\r\n\t\tif (LinkDetector.injectedHtmlCreator) {\r\n\t\t\treturn LinkDetector.injectedHtmlCreator(value);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn ttPolicy?.createHTML(value).toString();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Matches and handles web urls, absolute and relative file links in the string provided.\r\n\t * Returns <span/> element that wraps the processed string, where matched links are replaced by <a/>.\r\n\t * 'onclick' event is attached to all anchored links that opens them in the editor.\r\n\t * When splitLines is true, each line of the text, even if it contains no links, is wrapped in a <span>\r\n\t * and added as a child of the returned <span>.\r\n\t */\r\n\tlinkify(text: string, options: LinkOptions, splitLines?: boolean): HTMLElement {\r\n\t\tif (splitLines) {\r\n\t\t\tconst lines = text.split('\\n');\r\n\t\t\tfor (let i = 0; i < lines.length - 1; i++) {\r\n\t\t\t\tlines[i] = lines[i] + '\\n';\r\n\t\t\t}\r\n\t\t\tif (!lines[lines.length - 1]) {\r\n\t\t\t\t// Remove the last element ('') that split added.\r\n\t\t\t\tlines.pop();\r\n\t\t\t}\r\n\t\t\tconst elements = lines.map(line => this.linkify(line, options, false));\r\n\t\t\tif (elements.length === 1) {\r\n\t\t\t\t// Do not wrap single line with extra span.\r\n\t\t\t\treturn elements[0];\r\n\t\t\t}\r\n\t\t\tconst container = document.createElement('span');\r\n\t\t\telements.forEach(e => container.appendChild(e));\r\n\t\t\treturn container;\r\n\t\t}\r\n\r\n\t\tconst container = document.createElement('span');\r\n\t\tfor (const part of this.detectLinks(text, !!options.trustHtml, options.linkifyFilePaths)) {\r\n\t\t\ttry {\r\n\t\t\t\tlet span: HTMLSpanElement | null = null;\r\n\t\t\t\tswitch (part.kind) {\r\n\t\t\t\t\tcase 'text':\r\n\t\t\t\t\t\tcontainer.appendChild(document.createTextNode(part.value));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'web':\r\n\t\t\t\t\tcase 'path':\r\n\t\t\t\t\t\tcontainer.appendChild(this.createWebLink(part.value));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'html':\r\n\t\t\t\t\t\tspan = document.createElement('span');\r\n\t\t\t\t\t\tspan.innerHTML = this.createHtml(part.value)!;\r\n\t\t\t\t\t\tcontainer.appendChild(span);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tcontainer.appendChild(document.createTextNode(part.value));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn container;\r\n\t}\r\n\r\n\tprivate createWebLink(url: string): Node {\r\n\t\tconst link = this.createLink(url);\r\n\t\tlink.href = url;\r\n\t\treturn link;\r\n\t}\r\n\r\n\t// private createPathLink(text: string, path: string, lineNumber: number, columnNumber: number, workspaceFolder: string | undefined): Node {\r\n\t// \tif (path[0] === '/' && path[1] === '/') {\r\n\t// \t\t// Most likely a url part which did not match, for example ftp://path.\r\n\t// \t\treturn document.createTextNode(text);\r\n\t// \t}\r\n\r\n\t// \tconst options = { selection: { startLineNumber: lineNumber, startColumn: columnNumber } };\r\n\t// \tif (path[0] === '.') {\r\n\t// \t\tif (!workspaceFolder) {\r\n\t// \t\t\treturn document.createTextNode(text);\r\n\t// \t\t}\r\n\t// \t\tconst uri = workspaceFolder.toResource(path);\r\n\t// \t\tconst link = this.createLink(text);\r\n\t// \t\tthis.decorateLink(link, uri, (preserveFocus: boolean) => this.editorService.openEditor({ resource: uri, options: { ...options, preserveFocus } }));\r\n\t// \t\treturn link;\r\n\t// \t}\r\n\r\n\t// \tif (path[0] === '~') {\r\n\t// \t\tconst userHome = this.pathService.resolvedUserHome;\r\n\t// \t\tif (userHome) {\r\n\t// \t\t\tpath = osPath.join(userHome.fsPath, path.substring(1));\r\n\t// \t\t}\r\n\t// \t}\r\n\r\n\t// \tconst link = this.createLink(text);\r\n\t// \tlink.tabIndex = 0;\r\n\t// \tconst uri = URI.file(osPath.normalize(path));\r\n\t// \tthis.fileService.resolve(uri).then(stat => {\r\n\t// \t\tif (stat.isDirectory) {\r\n\t// \t\t\treturn;\r\n\t// \t\t}\r\n\t// \t\tthis.decorateLink(link, uri, (preserveFocus: boolean) => this.editorService.openEditor({ resource: uri, options: { ...options, preserveFocus } }));\r\n\t// \t}).catch(() => {\r\n\t// \t\t// If the uri can not be resolved we should not spam the console with error, remain quite #86587\r\n\t// \t});\r\n\t// \treturn link;\r\n\t// }\r\n\r\n\tprivate createLink(text: string): HTMLAnchorElement {\r\n\t\tconst link = document.createElement('a');\r\n\t\tlink.textContent = text;\r\n\t\treturn link;\r\n\t}\r\n\r\n\tprivate detectLinks(text: string, trustHtml: boolean, detectFilepaths: boolean): LinkPart[] {\r\n\t\tif (text.length > MAX_LENGTH) {\r\n\t\t\treturn [{ kind: 'text', value: text, captures: [] }];\r\n\t\t}\r\n\r\n\t\tconst regexes: RegExp[] = [];\r\n\t\tconst kinds: LinkKind[] = [];\r\n\t\tconst result: LinkPart[] = [];\r\n\r\n\t\tif (this.shouldGenerateHtml(trustHtml)) {\r\n\t\t\tregexes.push(HTML_LINK_REGEX);\r\n\t\t\tkinds.push('html');\r\n\t\t}\r\n\t\tregexes.push(WEB_LINK_REGEX);\r\n\t\tkinds.push('web');\r\n\t\tif (detectFilepaths) {\r\n\t\t\tregexes.push(PATH_LINK_REGEX);\r\n\t\t\tkinds.push('path');\r\n\t\t}\r\n\r\n\r\n\t\tconst splitOne = (text: string, regexIndex: number) => {\r\n\t\t\tif (regexIndex >= regexes.length) {\r\n\t\t\t\tresult.push({ value: text, kind: 'text', captures: [] });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst regex = regexes[regexIndex];\r\n\t\t\tlet currentIndex = 0;\r\n\t\t\tlet match;\r\n\t\t\tregex.lastIndex = 0;\r\n\t\t\twhile ((match = regex.exec(text)) !== null) {\r\n\t\t\t\tconst stringBeforeMatch = text.substring(currentIndex, match.index);\r\n\t\t\t\tif (stringBeforeMatch) {\r\n\t\t\t\t\tsplitOne(stringBeforeMatch, regexIndex + 1);\r\n\t\t\t\t}\r\n\t\t\t\tconst value = match[0];\r\n\t\t\t\tresult.push({\r\n\t\t\t\t\tvalue: value,\r\n\t\t\t\t\tkind: kinds[regexIndex],\r\n\t\t\t\t\tcaptures: match.slice(1)\r\n\t\t\t\t});\r\n\t\t\t\tcurrentIndex = match.index + value.length;\r\n\t\t\t}\r\n\t\t\tconst stringAfterMatches = text.substring(currentIndex);\r\n\t\t\tif (stringAfterMatches) {\r\n\t\t\t\tsplitOne(stringAfterMatches, regexIndex + 1);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tsplitOne(text, 0);\r\n\t\treturn result;\r\n\t}\r\n}\r\n\r\nconst linkDetector = new LinkDetector();\r\nexport function linkify(text: string, linkOptions: LinkOptions, splitLines?: boolean) {\r\n\treturn linkDetector.linkify(text, linkOptions, splitLines);\r\n}\r\n"]}