{"version":3,"file":"stackTraceHelper.js","sourceRoot":"","sources":["../src/stackTraceHelper.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\n\r\nexport function formatStackTrace(stack: string, trustHtml: boolean): { formattedStack: string; errorLocation?: string } {\r\n\tlet cleaned: string;\r\n\t// Ansi colors are described here:\r\n\t// https://en.wikipedia.org/wiki/ANSI_escape_code under the SGR section\r\n\r\n\t// Remove background colors. The ones from IPython don't work well with\r\n\t// themes 40-49 sets background color\r\n\tcleaned = stack.replace(/\\u001b\\[4\\dm/g, '');\r\n\tcleaned = cleaned.replace(/(?<=\\u001b\\[[\\d;]*?);4\\d(?=m)/g, '');\r\n\r\n\t// Also remove specific foreground colors (38 is the ascii code for picking one) (they don't translate either)\r\n\t// Turn them into default foreground\r\n\tcleaned = cleaned.replace(/\\u001b\\[38;.*?\\d+m/g, '\\u001b[39m');\r\n\r\n\t// Turn all foreground colors after the --> to default foreground\r\n\tcleaned = cleaned.replace(/(;32m[ ->]*?)(\\d+)(.*)\\n/g, (_s, prefix, num, suffix) => {\r\n\t\tsuffix = suffix.replace(/\\u001b\\[3\\d+m/g, '\\u001b[39m');\r\n\t\treturn `${prefix}${num}${suffix}\\n`;\r\n\t});\r\n\r\n\tif (isIpythonStackTrace(cleaned) && trustHtml) {\r\n\t\treturn linkifyStack(cleaned);\r\n\t}\r\n\r\n\treturn { formattedStack: cleaned };\r\n}\r\n\r\nconst formatSequence = /\\u001b\\[.+?m/g;\r\nconst fileRegex = /File\\s+(?:\\u001b\\[.+?m)?(.+):(\\d+)/;\r\n// look for the \"--->\" before a line number\r\nconst lineNumberRegex = /(-+>(?:\\u001b\\[[\\d;]*m|\\s)*)(\\d+)(.*)/;\r\n// just capturing parts of \"Cell In[3], line 2\" with lots of formatting in between\r\nconst cellRegex = /^(?<prefix>(?:\\u001b\\[[\\d;]*m|\\s)*Cell(?:\\u001b\\[[\\d;]*m|\\s)*In(?:\\u001b\\[[\\d;]*m|\\s)*\\[(?<executionCount>\\d+)\\](?:\\u001b\\[[\\d;]*m|\\s|,)+)(?<lineLabel>line (?<lineNumber>\\d+))[^\\n]*$/m;\r\n// older versions of IPython ~8.3.0\r\nconst inputRegex = /(?<prefix>Input\\s+?(?:\\u001b\\[.+?m)(?<cellLabel>In\\s*\\[(?<executionCount>\\d+)\\]))(?<postfix>.*)/;\r\n\r\nfunction isIpythonStackTrace(stack: string) {\r\n\treturn cellRegex.test(stack) || inputRegex.test(stack) || fileRegex.test(stack);\r\n}\r\n\r\nfunction stripFormatting(text: string) {\r\n\treturn text.replace(formatSequence, '').trim();\r\n}\r\n\r\ntype cellLocation = { kind: 'cell'; path: string };\r\ntype fileLocation = { kind: 'file'; path: string };\r\n\r\ntype location = cellLocation | fileLocation;\r\n\r\nfunction linkifyStack(stack: string): { formattedStack: string; errorLocation?: string } {\r\n\tconst lines = stack.split('\\n');\r\n\r\n\tlet fileOrCell: location | undefined;\r\n\tlet locationLink = '';\r\n\r\n\tfor (const i in lines) {\r\n\r\n\t\tconst original = lines[i];\r\n\t\tif (fileRegex.test(original)) {\r\n\t\t\tconst fileMatch = lines[i].match(fileRegex);\r\n\t\t\tfileOrCell = { kind: 'file', path: stripFormatting(fileMatch![1]) };\r\n\r\n\t\t\tcontinue;\r\n\t\t} else if (cellRegex.test(original)) {\r\n\t\t\tfileOrCell = {\r\n\t\t\t\tkind: 'cell',\r\n\t\t\t\tpath: stripFormatting(original.replace(cellRegex, 'vscode-notebook-cell:?execution_count=$<executionCount>'))\r\n\t\t\t};\r\n\t\t\tconst link = original.replace(cellRegex, `<a href=\\'${fileOrCell.path}&line=$<lineNumber>\\'>line $<lineNumber></a>`);\r\n\t\t\tlines[i] = original.replace(cellRegex, `$<prefix>${link}`);\r\n\t\t\tlocationLink = locationLink || link;\r\n\r\n\t\t\tcontinue;\r\n\t\t} else if (inputRegex.test(original)) {\r\n\t\t\tfileOrCell = {\r\n\t\t\t\tkind: 'cell',\r\n\t\t\t\tpath: stripFormatting(original.replace(inputRegex, 'vscode-notebook-cell:?execution_count=$<executionCount>'))\r\n\t\t\t};\r\n\t\t\tconst link = original.replace(inputRegex, `<a href=\\'${fileOrCell.path}\\'>$<cellLabel></a>`);\r\n\t\t\tlines[i] = original.replace(inputRegex, `Input ${link}$<postfix>`);\r\n\r\n\t\t\tcontinue;\r\n\t\t} else if (!fileOrCell || original.trim() === '') {\r\n\t\t\t// we don't have a location, so don't linkify anything\r\n\t\t\tfileOrCell = undefined;\r\n\r\n\t\t\tcontinue;\r\n\t\t} else if (lineNumberRegex.test(original)) {\r\n\t\t\tlines[i] = original.replace(lineNumberRegex, (_s, prefix, num, suffix) => {\r\n\t\t\t\treturn fileOrCell?.kind === 'file' ?\r\n\t\t\t\t\t`${prefix}<a href='${fileOrCell?.path}:${num}'>${num}</a>${suffix}` :\r\n\t\t\t\t\t`${prefix}<a href='${fileOrCell?.path}&line=${num}'>${num}</a>${suffix}`;\r\n\t\t\t});\r\n\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t}\r\n\r\n\tconst errorLocation = locationLink;\r\n\treturn { formattedStack: lines.join('\\n'), errorLocation };\r\n}\r\n"]}